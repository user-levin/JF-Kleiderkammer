import{r as o,j as a}from"./index-DLvFhXsc.js";import{u as E}from"./useMutation-BXLqj6I4.js";import{a as D}from"./client-CSqpDYkL.js";const f="__custom",K=Array.from({length:9},(e,n)=>String(80+n*5)),k=[{key:"helm",label:"Helm",sizeOptions:["Einheitsgröße"],defaultSize:"Einheitsgröße"},{key:"handschuhe",label:"Handschuhe",sizeOptions:["8","9","10","11"]},{key:"jacke",label:"Jacke"},{key:"hose",label:"Hose"},{key:"koppel",label:"Koppel",sizeOptions:K,allowCustomSize:!0}];function O(e){if(e)return k.find(n=>n.key===e)}function _(e){const n=e.trim().toLowerCase();if(n)return k.find(r=>r.label.toLowerCase()===n)}const M=e=>({category:e.category,size:e.size??"",expiryDate:e.expiryDate??"",helmetManufacturedAt:e.helmetManufacturedAt??"",helmetLastCheck:e.helmetLastCheck??"",helmetNextCheck:e.helmetNextCheck??""}),F=new Intl.DateTimeFormat("de-DE",{dateStyle:"medium",timeStyle:"short"}),H=new Intl.DateTimeFormat("de-DE",{dateStyle:"medium"});function J({article:e,childrenOptions:n,onClose:r,onUpdated:h}){const[l,i]=o.useState(()=>M(e)),[u,C]=o.useState(e.location.kindId?String(e.location.kindId):""),[w,c]=o.useState(null),[b,d]=o.useState(null),[y,j]=o.useState("");o.useEffect(()=>{i(M(e)),C(e.location.kindId?String(e.location.kindId):""),c(null),d(null),j("")},[e]);const m=l.category.trim().toLowerCase()==="helm";o.useEffect(()=>{if(!m)return;const t=Z(l.helmetManufacturedAt);i(s=>t&&t!==s.expiryDate?{...s,expiryDate:t}:!t&&s.expiryDate!==""?{...s,expiryDate:""}:s)},[m,l.helmetManufacturedAt]);const z=o.useMemo(()=>[...n].sort((t,s)=>t.status!==s.status?t.status==="aktiv"?-1:1:t.lastName.localeCompare(s.lastName,"de")||t.firstName.localeCompare(s.firstName,"de")),[n]),S=o.useMemo(()=>Y(e),[e]),v=E({mutationFn:async t=>(await D.patch(`/api/articles/${e.id}`,t)).data.data,onSuccess:t=>{c("Artikel wurde gespeichert."),d(null),h(t)},onError:t=>{d(t instanceof Error?t.message:"Artikel konnte nicht gespeichert werden.")}}),x=E({mutationFn:async t=>(await D.patch(`/api/articles/${e.id}/assignment`,t)).data.data,onSuccess:t=>{c("Zuweisung aktualisiert."),d(null),h(t)},onError:t=>{d(t instanceof Error?t.message:"Zuweisung konnte nicht angepasst werden.")}}),N=_(l.category),A=(N==null?void 0:N.key)??f,L=t=>{if(t===f){i(p=>({...p,category:""}));return}const s=O(t);i(p=>({...p,category:(s==null?void 0:s.label)??p.category}))},T=t=>{t.preventDefault();const s=$(e,l);if(y.trim()&&(s.notes=y.trim()),Object.keys(s).length===0){c("Keine Änderungen erkannt.");return}c(null),d(null),v.mutate(s,{onSuccess:()=>j("")})},I=()=>{u&&(c(null),d(null),x.mutate({targetType:"kind",kindId:Number(u)}))},P=()=>{c(null),d(null),x.mutate({targetType:"lager"})};return a.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:a.jsxs("div",{className:"modal-card",children:[a.jsxs("header",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("p",{className:"muted",children:"Artikel"}),a.jsx("h3",{children:e.id})]}),a.jsx("button",{type:"button",className:"ghost-button",onClick:r,children:"Schließen"})]}),a.jsxs("div",{className:"modal-body",children:[a.jsxs("form",{className:"modal-form",onSubmit:T,children:[a.jsxs("label",{children:["Artikel-ID",a.jsx("input",{value:e.id,disabled:!0})]}),a.jsxs("label",{children:["Bezeichnung (automatisch)",a.jsx("input",{value:e.label,disabled:!0})]}),a.jsxs("label",{children:["Kategorie*",a.jsxs("select",{value:A,onChange:t=>L(t.target.value),required:!0,children:[k.map(t=>a.jsx("option",{value:t.key,children:t.label},t.key)),a.jsx("option",{value:f,children:"Eigene Kategorie"})]})]}),A===f&&a.jsxs("label",{children:["Eigene Kategorie",a.jsx("input",{value:l.category,onChange:t=>i(s=>({...s,category:t.target.value})),required:!0})]}),a.jsxs("div",{className:"modal-row",children:[a.jsxs("label",{children:["Größe",a.jsx("input",{value:l.size,onChange:t=>i(s=>({...s,size:t.target.value}))})]}),a.jsxs("label",{children:["Ablaufdatum ",m&&a.jsx("span",{className:"muted",children:"(berechnet +10 Jahre)"}),a.jsx("input",{type:"date",value:l.expiryDate,onChange:t=>i(s=>({...s,expiryDate:t.target.value})),disabled:m})]})]}),m&&a.jsxs("div",{className:"modal-row",children:[a.jsxs("label",{children:["Herstellungsdatum*",a.jsx("input",{type:"date",value:l.helmetManufacturedAt,onChange:t=>i(s=>({...s,helmetManufacturedAt:t.target.value})),required:!0})]}),a.jsxs("label",{children:["Letzte Prüfung",a.jsx("input",{type:"date",value:l.helmetLastCheck,onChange:t=>i(s=>({...s,helmetLastCheck:t.target.value}))})]}),a.jsxs("label",{children:["Nächste Prüfung",a.jsx("input",{type:"date",value:l.helmetNextCheck,onChange:t=>i(s=>({...s,helmetNextCheck:t.target.value}))})]})]}),a.jsxs("label",{children:["Notizen (Chronik)",a.jsx("textarea",{rows:5,value:e.notes??"",readOnly:!0,className:"note-log"})]}),a.jsxs("label",{children:["Neue Notiz",a.jsx("textarea",{rows:3,value:y,onChange:t=>j(t.target.value),placeholder:"Wird beim Speichern mit Zeitstempel ergänzt"})]}),a.jsx("div",{className:"modal-actions",children:a.jsx("button",{type:"submit",disabled:v.isPending,children:"Änderungen speichern"})})]}),a.jsxs("aside",{className:"modal-sidebar",children:[S.length>0&&a.jsxs("div",{className:"sidebar-card",children:[a.jsx("h4",{children:"Verlauf"}),a.jsx("ol",{className:"article-timeline",children:S.map(t=>a.jsxs("li",{children:[a.jsx("p",{className:"timeline-label",children:t.label}),a.jsx("p",{className:"timeline-date",children:t.date}),t.meta&&a.jsx("p",{className:"timeline-meta",children:t.meta})]},`${t.label}-${t.date}`))})]}),a.jsxs("div",{className:"sidebar-card",children:[a.jsx("h4",{children:"Zuweisung"}),a.jsxs("label",{children:["Kind auswählen",a.jsxs("select",{value:u,onChange:t=>C(t.target.value),children:[a.jsx("option",{value:"",children:"Bitte auswählen"}),z.map(t=>a.jsxs("option",{value:t.id,children:[R(t),t.status==="inaktiv"?" (inaktiv)":""]},t.id))]})]}),a.jsxs("div",{className:"sidebar-actions",children:[a.jsx("button",{type:"button",onClick:I,disabled:!u||x.isPending,children:"Zu Kind zuordnen"}),a.jsx("button",{type:"button",className:"ghost-button",onClick:P,disabled:x.isPending,children:"Zurück ins Lager"})]})]}),(w||b)&&a.jsx("p",{className:b?"error-text":"info-text",children:b??w})]})]})]})})}function Z(e){if(!e)return null;const n=new Date(e);return Number.isNaN(n.getTime())?null:(n.setFullYear(n.getFullYear()+10),n.toISOString().slice(0,10))}function $(e,n){const r={},h=u=>(u??"").trim(),l=u=>u&&u.trim()!==""?u:null,i=n.category.trim().toLowerCase()==="helm";return h(n.category)!==e.category&&(r.category=n.category.trim()),h(n.size)!==h(e.size)&&(r.size=n.size.trim()),!i&&l(n.expiryDate)!==l(e.expiryDate)&&(r.expiryDate=n.expiryDate||null),l(n.helmetManufacturedAt)!==l(e.helmetManufacturedAt)&&(r.helmetManufacturedAt=n.helmetManufacturedAt||null),l(n.helmetLastCheck)!==l(e.helmetLastCheck)&&(r.helmetLastCheck=n.helmetLastCheck||null),l(n.helmetNextCheck)!==l(e.helmetNextCheck)&&(r.helmetNextCheck=n.helmetNextCheck||null),r}function R(e){return`${e.firstName} ${e.lastName}`.trim()}function Y(e){const n=[];return n.push({label:"Zuletzt bewegt",date:B(e.assignedAt),meta:e.location.type==="kind"?`Aktuell bei ${e.location.name}`:"Aktuell im Lager"}),e.warning&&n.push({label:e.warning.type==="pruefung"?"Prüfung fällig":"Ablaufwarnung",date:g(e.warning.date),meta:`Fenster ${e.warning.windowDays} Tage`}),e.expiryDate&&n.push({label:"Ablaufdatum",date:g(e.expiryDate)}),e.helmetManufacturedAt&&n.push({label:"Helm produziert",date:g(e.helmetManufacturedAt)}),e.helmetLastCheck&&n.push({label:"Letzte Prüfung",date:g(e.helmetLastCheck)}),e.helmetNextCheck&&n.push({label:"Nächste Prüfung",date:g(e.helmetNextCheck)}),n}function B(e){if(!e)return"-";const n=new Date(e);return Number.isNaN(n.getTime())?"-":F.format(n)}function g(e){if(!e)return"-";const n=new Date(e);return Number.isNaN(n.getTime())?"-":H.format(n)}export{J as A,k as C,f as a,O as f,_ as m};
