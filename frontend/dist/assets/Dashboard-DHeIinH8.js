import{u as w,r as p,j as e}from"./index-DLvFhXsc.js";import{u as z}from"./useQuery-Cnopp4RL.js";import{u as v}from"./useMutation-BXLqj6I4.js";import{a as f}from"./client-CSqpDYkL.js";const R=30,E=new Intl.DateTimeFormat("de-DE",{dateStyle:"medium"});function G({onLogout:t}){const n=w(),{data:A,isLoading:D,isFetching:k,error:N,refetch:C}=z({queryKey:["articles"],queryFn:async()=>(await f.get("/api/articles")).data.data}),h=A??[],u=p.useMemo(()=>{const s=new Date,i=new Date(s.getTime()+R*24*60*60*1e3);return h.filter(a=>{var l;return((l=a.category)==null?void 0:l.toLowerCase())==="helm"}).map(a=>{const l=b(a.helmetNextCheck),d=b(a.expiryDate);let r="warning",o=null;return l?l<=s?(o=`Prüfung überfällig (${m(a.helmetNextCheck)})`,r="critical"):l<=i&&(o=`Prüfung fällig bis ${m(a.helmetNextCheck)}`):o="Keine Prüfung dokumentiert",d&&(d<=s?(o=`Ablaufdatum überschritten (${m(a.expiryDate)})`,r="critical"):d<=i&&(o=`Läuft ab bis ${m(a.expiryDate)}`)),o?{article:a,reason:o,severity:r}:null}).filter(a=>!!a)},[h]),x=p.useMemo(()=>{const s=new Map;for(const i of h){const a=i.category||"Unbekannt",l=i.size||"One Size",d=`${a.toLowerCase()}__${l.toLowerCase()}`;s.has(d)||s.set(d,{key:d,category:a,sizeLabel:l,total:0,children:0,storage:0,childRatio:0,storageRatio:0});const r=s.get(d);r.total+=1,i.location.type==="kind"?r.children+=1:r.storage+=1,r.childRatio=r.total?r.children/r.total:0,r.storageRatio=r.total?r.storage/r.total:0}return Array.from(s.values()).sort((i,a)=>i.category.localeCompare(a.category,"de-DE")||i.sizeLabel.localeCompare(a.sizeLabel,"de-DE"))},[h]),y=p.useMemo(()=>x.map(s=>({...s,demandScore:s.childRatio,shortageLevel:s.storage<=1?"kritisch":s.storage<=3?"niedrig":"stabil"})).filter(s=>s.demandScore>=.6&&s.storage<=3).sort((s,i)=>i.demandScore-s.demandScore).slice(0,6),[x]),c=p.useMemo(()=>{const s=h.length,i=h.filter(l=>l.location.type==="kind").length,a=s-i;return{total:s,children:i,storage:a,helmetsDue:u.length}},[h,u.length]),g=v({mutationFn:async s=>{await f.post(`/api/articles/${s}/helmet-check`,{date:new Date().toISOString().slice(0,10)})},onSuccess:()=>n.invalidateQueries({queryKey:["articles"]})}),j=v({mutationFn:async s=>{await f.delete(`/api/articles/${s}`)},onSuccess:()=>n.invalidateQueries({queryKey:["articles"]})}),$=s=>{g.mutate(s)},S=s=>{window.confirm("Artikel wirklich aussondern? Dies entfernt ihn dauerhaft.")&&j.mutate(s)};return e.jsxs("div",{className:"dashboard-grid",children:[e.jsxs("section",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Dashboard"}),e.jsx("p",{className:"muted",children:"Live-Daten aus der Kleiderkammer"})]}),e.jsxs("div",{className:"card-actions",children:[e.jsx("button",{className:"ghost-button",onClick:()=>C(),disabled:k,children:k?"Aktualisiere...":"Aktualisieren"}),t&&e.jsx("button",{onClick:t,children:"Logout"})]})]}),N&&e.jsx("p",{className:"error",children:N instanceof Error?N.message:"Fehler beim Laden."}),D?e.jsx("p",{className:"muted",children:"Bestandsdaten werden geladen ..."}):e.jsxs("div",{className:"stat-grid",children:[e.jsxs("article",{className:"stat-card",children:[e.jsx("p",{className:"stat-label",children:"Artikel insgesamt"}),e.jsx("p",{className:"stat-value",children:c.total})]}),e.jsxs("article",{className:"stat-card",children:[e.jsx("p",{className:"stat-label",children:"Bei Kindern"}),e.jsx("p",{className:"stat-value",children:c.children}),e.jsxs("span",{className:"muted",children:[L(c.children,c.total)," ausgeliehen"]})]}),e.jsxs("article",{className:"stat-card",children:[e.jsx("p",{className:"stat-label",children:"Im Lager"}),e.jsx("p",{className:"stat-value",children:c.storage}),e.jsxs("span",{className:"muted",children:[L(c.storage,c.total)," Reserve"]})]}),e.jsxs("article",{className:"stat-card",children:[e.jsx("p",{className:"stat-label",children:"Helme mit Aktion"}),e.jsx("p",{className:"stat-value warning",children:c.helmetsDue}),e.jsx("span",{className:"muted",children:"Prüfung oder Ablauf innerhalb 30 Tage"})]})]})]}),e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{children:[e.jsx("h3",{children:"Bestandsverteilung"}),e.jsx("p",{className:"muted",children:"Artikeltyp x Größe · Kinder vs Lager"})]})}),x.length===0?e.jsx("p",{className:"muted",children:"Noch keine Artikel vorhanden."}):e.jsx("div",{className:"distribution-table-wrapper",children:e.jsxs("table",{className:"distribution-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Typ"}),e.jsx("th",{children:"Größe"}),e.jsx("th",{children:"Bei Kindern"}),e.jsx("th",{children:"Im Lager"}),e.jsx("th",{children:"Gesamt"})]})}),e.jsx("tbody",{children:x.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.category}),e.jsx("td",{children:s.sizeLabel}),e.jsxs("td",{children:[e.jsx("span",{children:s.children}),e.jsx("div",{className:"distribution-bar","aria-label":`Bei Kindern: ${s.children}`,children:e.jsx("div",{className:"bar bar-children",style:{width:`${s.childRatio*100}%`}})})]}),e.jsxs("td",{children:[e.jsx("span",{children:s.storage}),e.jsx("div",{className:"distribution-bar","aria-label":`Im Lager: ${s.storage}`,children:e.jsx("div",{className:"bar bar-storage",style:{width:`${s.storageRatio*100}%`}})})]}),e.jsx("td",{children:s.total})]},s.key))})]})})]}),e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{children:[e.jsx("h3",{children:"Engpass-Radar"}),e.jsx("p",{className:"muted",children:"Welche Größen sind stark gefragt und kaum verfügbar?"})]})}),y.length===0?e.jsx("p",{className:"muted",children:"Aktuell keine Engpässe erkannt. Weiter so!"}):e.jsx("div",{className:"demand-grid",children:y.map(s=>e.jsxs("article",{className:"demand-card",children:[e.jsxs("header",{children:[e.jsx("strong",{children:s.category}),e.jsxs("span",{children:["Größe ",s.sizeLabel]})]}),e.jsxs("p",{className:"demand-score",children:[Math.round(s.demandScore*100),"% ausgeliehen"]}),e.jsxs("p",{className:"muted",children:["Nur ",s.storage," im Lager · ",s.children," bei Kindern"]}),e.jsx("span",{className:`badge ${s.shortageLevel==="kritisch"?"badge-critical":"badge-warning"}`,children:s.shortageLevel==="kritisch"?"Kritisch":"Niedrige Reserve"})]},s.key))})]}),e.jsxs("section",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Helm-Prüfungen & Ablauf"}),e.jsx("p",{className:"muted",children:"Alerts für Prüfzyklen (+2 Jahre) oder Ablaufdatum"})]}),e.jsx("span",{className:`badge ${u.length?"badge-warning":""}`,children:u.length})]}),u.length===0?e.jsx("p",{className:"muted",children:"Alle Helme sind aktuell innerhalb des Prüfzeitraums."}):e.jsx("div",{className:"helmet-alert-grid",children:u.map(s=>e.jsxs("article",{className:`helmet-alert-card ${s.severity==="critical"?"critical":"warning"}`,children:[e.jsxs("div",{className:"helmet-alert-header",children:[e.jsxs("span",{className:"helmet-article-id",children:["#",s.article.id]}),e.jsx("span",{className:`tag ${s.article.location.type==="kind"?"tag-kind":"tag-lager"}`,children:s.article.location.type==="kind"?s.article.location.name:"Lager"})]}),e.jsx("p",{children:s.reason}),e.jsxs("ul",{className:"helmet-meta",children:[e.jsxs("li",{children:["Artikel: ",s.article.label]}),e.jsxs("li",{children:["Größe: ",s.article.size??"One Size"]}),e.jsxs("li",{children:["Letzte Prüfung: ",m(s.article.helmetLastCheck)]}),e.jsxs("li",{children:["Nächste Prüfung: ",m(s.article.helmetNextCheck)]}),e.jsxs("li",{children:["Ablaufdatum: ",m(s.article.expiryDate)]})]}),e.jsxs("div",{className:"helmet-actions",children:[e.jsx("button",{onClick:()=>$(s.article.id),disabled:g.isLoading,children:"Prüfung abschließen"}),e.jsx("button",{className:"ghost-button danger",onClick:()=>S(s.article.id),disabled:j.isLoading,children:"Aussondern"})]})]},s.article.id))}),(g.isError||j.isError)&&e.jsxs("p",{className:"error",children:["Aktion fehlgeschlagen: ",M(g.error??j.error)]})]})]})}function b(t){if(!t)return null;const n=Date.parse(t);return Number.isNaN(n)?null:new Date(n)}function m(t){if(!t)return"-";const n=b(t);return n?E.format(n):t}function L(t,n){return n===0?"0%":`${Math.round(t/n*100)}%`}function M(t){return t instanceof Error?t.message:"Bitte erneut versuchen."}export{G as default};
