import{b as J,u as W,r as a,j as t}from"./index-DLvFhXsc.js";import{u as V}from"./useQuery-Cnopp4RL.js";import{u as F}from"./useMutation-BXLqj6I4.js";import{a as f,b as X}from"./client-CSqpDYkL.js";import{A as ee}from"./ArticleModal-CMvB0Wmf.js";const C={firstName:"",lastName:""};function re(){var D,T;const i=J(),v=W(),[m,j]=a.useState(""),[p,B]=a.useState("alle"),[N,S]=a.useState({...C}),[l,w]=a.useState(null),[x,g]=a.useState({...C}),[I,A]=a.useState("aktiv"),[L,E]=a.useState(null),[K,d]=a.useState(null),[n,b]=a.useState(null),[q,u]=a.useState(null),c=V({queryKey:["children"],queryFn:async()=>(await f.get("/api/children")).data.data});a.useEffect(()=>{if(!l){g({...C}),A("aktiv");return}g({firstName:l.firstName,lastName:l.lastName}),A(l.status)},[l]),a.useEffect(()=>{if(!n||!c.data)return;const e=c.data.find(s=>s.id===n.id);e?e!==n&&b(e):(b(null),u(null))},[c.data,n]),a.useEffect(()=>{n||u(null)},[n]);const P=a.useMemo(()=>{const e=c.data??[],s=m.trim().toLowerCase();return e.filter(o=>p==="alle"||o.status===p).filter(o=>s?`${o.firstName} ${o.lastName}`.toLowerCase().includes(s):!0).sort((o,$)=>o.lastName.localeCompare($.lastName,"de")||o.firstName.localeCompare($.firstName,"de"))},[c.data,m,p]),k=()=>v.invalidateQueries({queryKey:["children"]}),h=n==null?void 0:n.id,r=V({queryKey:["child-articles",h],queryFn:async()=>h?(await f.get(`/api/children/${h}/articles`)).data.data:[],enabled:!!h}),O=e=>{u(e),h&&v.invalidateQueries({queryKey:["child-articles",h]}),k()},z=F({mutationFn:async e=>(await f.post("/api/children",e)).data.data,onSuccess:()=>{S({...C}),E("Kind wurde angelegt."),d(null),k()},onError:e=>{d(M(e))}}),y=F({mutationFn:async({id:e,payload:s})=>(await f.patch(`/api/children/${e}`,s)).data.data,onSuccess:(e,s)=>{E("Kind wurde aktualisiert."),d(null),l&&s.id===l.id&&w(null),k()},onError:e=>{d(M(e))}}),Q=F({mutationFn:async e=>{await f.delete(`/api/children/${e}`)},onSuccess:()=>{E("Kind wurde gelöscht."),d(null),k()},onError:e=>{d(M(e))}}),R=e=>{if(e.preventDefault(),!N.firstName.trim()||!N.lastName.trim()){d("Vor- und Nachname werden benötigt.");return}z.mutate({firstName:N.firstName.trim(),lastName:N.lastName.trim()})},U=e=>{if(e.preventDefault(),!!l){if(!x.firstName.trim()||!x.lastName.trim()){d("Vor- und Nachname werden benötigt.");return}y.mutate({id:l.id,payload:{firstName:x.firstName.trim(),lastName:x.lastName.trim(),status:I}})}},_=e=>{const s=e.status==="aktiv"?"inaktiv":"aktiv";y.mutate({id:e.id,payload:{status:s}})},G=e=>{typeof window<"u"&&!window.confirm(`Soll ${e.firstName} ${e.lastName} wirklich gelöscht werden?`)||Q.mutate(e.id)},Y=e=>{b(s=>(s==null?void 0:s.id)===e.id?s:e),u(null)},Z=(e,s)=>{e.stopPropagation(),i(`/inventar?child=${s}`)},H=()=>{b(null),u(null)};return t.jsxs("div",{className:"children-layout",children:[t.jsxs("div",{className:"children-columns",children:[t.jsxs("section",{className:"card child-card",children:[t.jsx("div",{className:"card-header",children:t.jsxs("div",{children:[t.jsx("h2",{children:"Kind hinzufügen"}),t.jsx("p",{className:"muted",children:"Neue Zuordnung vorbereiten"})]})}),t.jsxs("form",{className:"child-form",onSubmit:R,children:[t.jsxs("label",{children:["Vorname*",t.jsx("input",{value:N.firstName,onChange:e=>S(s=>({...s,firstName:e.target.value}))})]}),t.jsxs("label",{children:["Nachname*",t.jsx("input",{value:N.lastName,onChange:e=>S(s=>({...s,lastName:e.target.value}))})]}),t.jsx("button",{type:"submit",disabled:z.isPending,children:"Kind speichern"})]})]}),l&&t.jsxs("section",{className:"card child-card",children:[t.jsxs("div",{className:"card-header",children:[t.jsx("div",{children:t.jsx("h3",{children:"Kind bearbeiten"})}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>w(null),children:"Schließen"})]}),t.jsxs("form",{className:"child-form",onSubmit:U,children:[t.jsxs("label",{children:["Vorname*",t.jsx("input",{value:x.firstName,onChange:e=>g(s=>({...s,firstName:e.target.value}))})]}),t.jsxs("label",{children:["Nachname*",t.jsx("input",{value:x.lastName,onChange:e=>g(s=>({...s,lastName:e.target.value}))})]}),t.jsxs("label",{children:["Status",t.jsxs("select",{value:I,onChange:e=>A(e.target.value),children:[t.jsx("option",{value:"aktiv",children:"Aktiv"}),t.jsx("option",{value:"inaktiv",children:"Inaktiv"})]})]}),t.jsx("button",{type:"submit",disabled:y.isPending,children:"Änderungen speichern"})]})]})]}),t.jsxs("section",{className:"card child-list-card",children:[t.jsxs("div",{className:"card-header child-list-header",children:[t.jsxs("div",{children:[t.jsx("h2",{children:"Alle Kinder"}),t.jsx("p",{className:"muted",children:"Suche und Filter anwenden"})]}),t.jsxs("div",{className:"child-filter-bar",children:[t.jsx("input",{type:"search",placeholder:"Suchen...",value:m,onChange:e=>j(e.target.value)}),t.jsxs("select",{value:p,onChange:e=>B(e.target.value),children:[t.jsx("option",{value:"alle",children:"Alle"}),t.jsx("option",{value:"aktiv",children:"Aktiv"}),t.jsx("option",{value:"inaktiv",children:"Inaktiv"})]})]})]}),c.isLoading&&t.jsx("p",{className:"muted",children:"Lade Kinder ..."}),!c.isLoading&&P.length===0&&t.jsx("p",{className:"muted",children:"Keine Kinder mit den aktuellen Filtern gefunden."}),t.jsx("div",{className:"child-list",children:P.map(e=>t.jsxs("article",{className:`child-row ${h===e.id?"is-selected":""}`,children:[t.jsxs("div",{className:"child-info-button",onClick:()=>Y(e),children:[t.jsxs("p",{className:"child-name",onClick:s=>Z(s,e.id),children:[e.firstName," ",e.lastName]}),t.jsxs("p",{className:"muted",children:[e.articleCount??0," Artikel aktuell"]})]}),t.jsx("span",{className:`status-badge ${e.status==="aktiv"?"is-success":"is-muted"}`,children:e.status==="aktiv"?"Aktiv":"Inaktiv"}),t.jsxs("div",{className:"child-actions",children:[t.jsx("button",{type:"button",onClick:()=>w(e),children:"Bearbeiten"}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>_(e),disabled:y.isPending,children:e.status==="aktiv"?"Inaktiv setzen":"Aktivieren"}),t.jsx("button",{type:"button",className:"ghost-button danger",onClick:()=>G(e),disabled:Q.isPending,children:"Löschen"})]})]},e.id))}),(L||K)&&t.jsx("p",{className:K?"error-text":"info-text",children:K??L})]}),n&&t.jsxs("section",{className:"card child-inventory-card",children:[t.jsxs("div",{className:"card-header",children:[t.jsxs("div",{children:[t.jsx("h3",{children:te(n)}),t.jsxs("p",{className:"muted",children:[r.isLoading&&"Artikel werden geladen ...",!r.isLoading&&`${((D=r.data)==null?void 0:D.length)??0} Artikel zugeordnet`]})]}),t.jsxs("div",{className:"child-panel-actions",children:[t.jsx("button",{type:"button",onClick:()=>i(`/inventar?child=${n.id}`),children:"Im Inventar öffnen"}),t.jsx("button",{type:"button",className:"ghost-button",onClick:H,children:"Schließen"})]})]}),r.isError&&t.jsx("p",{className:"error-text",children:"Artikel konnten nicht geladen werden."}),r.isSuccess&&(((T=r.data)==null?void 0:T.length)??0)===0&&t.jsx("p",{className:"muted",children:"Dem Kind sind aktuell keine Artikel zugeordnet."}),r.isSuccess&&r.data&&r.data.length>0&&t.jsx("div",{className:"child-article-list",children:r.data.map(e=>t.jsxs("article",{className:"child-article-row",children:[t.jsxs("div",{children:[t.jsx("p",{className:"child-article-title",children:e.label}),t.jsxs("p",{className:"child-article-meta",children:["ID ",e.id," · ",e.category,e.size?` · Größe ${e.size}`:""]})]}),t.jsx("div",{className:"child-article-actions",children:t.jsx("button",{type:"button",onClick:()=>u(e),children:"Bearbeiten"})})]},e.id))})]}),q&&t.jsx(ee,{article:q,childrenOptions:c.data??[],onClose:()=>u(null),onUpdated:O})]})}function M(i){var v,m;if(X.isAxiosError(i)){const j=(m=(v=i.response)==null?void 0:v.data)==null?void 0:m.error;if(typeof j=="string")return j}return i instanceof Error?i.message:"Aktion konnte nicht abgeschlossen werden."}function te(i){return`${i.firstName} ${i.lastName}`.trim()}export{re as default};
