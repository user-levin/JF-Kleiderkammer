import{r as a,b as Q,c as U,u as W,j as n}from"./index-DLvFhXsc.js";import{u as w}from"./useQuery-Cnopp4RL.js";import{u as _}from"./useMutation-BXLqj6I4.js";import{a as v}from"./client-CSqpDYkL.js";import{m as B,a as S,C as G,A as Y}from"./ArticleModal-CMvB0Wmf.js";const Z=new Intl.DateTimeFormat("de-DE",{dateStyle:"short",timeStyle:"short"});function ae(){var C;const[s,F]=a.useState(""),[l,K]=a.useState("alle"),[c,T]=a.useState("alle"),[r,L]=a.useState("alle"),[o,O]=a.useState(!1),[g,d]=a.useState(null),E=Q(),[f,I]=U(),u=f.get("child")??"",N=W(),{data:h=[],isLoading:M,isFetching:k,error:P,refetch:D}=w({queryKey:["articles"],queryFn:async()=>(await v.get("/api/articles")).data.data,staleTime:3e4}),m=w({queryKey:["children"],queryFn:async()=>(await v.get("/api/children")).data.data,staleTime:6e4}),x=s.trim().toLowerCase(),i=u&&!Number.isNaN(Number(u))?Number(u):null,$=e=>{const t=new URLSearchParams(f);e?t.set("child",e):t.delete("child"),I(t,{replace:!0})},j=a.useMemo(()=>h.filter(e=>{if(l!=="alle"&&e.status!==l||c!=="alle"&&e.location.type!==c||o&&!e.warning)return!1;if(r!=="alle"){const y=B(e.category);if(r===S){if(y)return!1}else if(!y||y.key!==r)return!1}if(i!==null&&(e.location.type!=="kind"||e.location.kindId!==i))return!1;if(!x)return!0;const t=e.location.name??"",R=e.location.type==="kind"?"kind":"lager";return`${e.id} ${e.label} ${e.category} ${t} ${R}`.toLowerCase().includes(x)}).sort((e,t)=>e.id.localeCompare(t.id,"de-DE")),[h,l,c,r,o,x,i]),b=a.useMemo(()=>g?h.find(e=>e.id===g)??null:null,[h,g]),p=i!==null&&m.data?m.data.find(e=>e.id===i)??null:null,q=e=>{d(e.id),N.invalidateQueries({queryKey:["articles"]})},A=_({mutationFn:async e=>(await v.delete(`/api/articles/${e}`),e),onSuccess:e=>{d(t=>t===e?null:t),N.invalidateQueries({queryKey:["articles"]})}}),z=e=>{window.confirm("Diesen Artikel wirklich löschen? Dies kann nicht rückgängig gemacht werden.")&&A.mutate(e)};return n.jsxs("div",{className:"inventory-layout",children:[n.jsxs("section",{className:"card inventory-controls",children:[n.jsxs("div",{className:"card-header",children:[n.jsxs("div",{children:[n.jsx("h2",{children:"Inventar"}),n.jsx("p",{className:"muted",children:"Artikel nach Kind, Kategorie oder Ort finden"})]}),n.jsxs("div",{className:"inventory-header-actions",children:[n.jsx("button",{type:"button",onClick:()=>E("/scan"),children:"Artikel hinzufügen"}),n.jsx("button",{className:"ghost-button",type:"button",onClick:()=>D(),disabled:k,children:k?"Aktualisiere…":"Aktualisieren"})]})]}),n.jsxs("div",{className:"inventory-filters",children:[n.jsx("input",{type:"search",placeholder:"Suche nach Kind, Kategorie oder Ort",value:s,onChange:e=>F(e.target.value)}),n.jsxs("select",{value:l,onChange:e=>K(e.target.value),children:[n.jsx("option",{value:"alle",children:"Status: Alle"}),n.jsx("option",{value:"frei",children:"Im Lager"}),n.jsx("option",{value:"ausgegeben",children:"Bei Kindern"}),n.jsx("option",{value:"warnung",children:"Warnung aktiv"})]}),n.jsxs("select",{value:c,onChange:e=>T(e.target.value),children:[n.jsx("option",{value:"alle",children:"Ort: Alle"}),n.jsx("option",{value:"lager",children:"Nur Lager"}),n.jsx("option",{value:"kind",children:"Nur Kinder"})]}),n.jsxs("select",{value:r,onChange:e=>L(e.target.value),children:[n.jsx("option",{value:"alle",children:"Alle Kategorien"}),G.map(e=>n.jsx("option",{value:e.key,children:e.label},e.key)),n.jsx("option",{value:S,children:"Weitere Kategorien"})]}),n.jsxs("select",{value:u,onChange:e=>$(e.target.value),children:[n.jsx("option",{value:"",children:"Kinder: Alle"}),(C=m.data)==null?void 0:C.map(e=>n.jsxs("option",{value:e.id,children:[e.firstName," ",e.lastName]},e.id))]}),n.jsxs("label",{className:`filter-toggle ${o?"is-active":""}`,children:[n.jsx("input",{type:"checkbox",checked:o,onChange:e=>O(e.target.checked)}),n.jsx("span",{children:"Nur Warnungen"})]})]})]}),n.jsxs("section",{className:"card inventory-list-card",children:[P&&n.jsx("p",{className:"error-text",children:"Inventar konnte nicht geladen werden."}),M?n.jsx("p",{className:"muted",children:"Artikel werden geladen ..."}):j.length===0?n.jsx("p",{className:"muted",children:"Keine Artikel mit den aktuellen Filtern gefunden."}):n.jsxs(n.Fragment,{children:[n.jsxs("p",{className:"muted",children:[j.length," Artikel angezeigt"]}),p&&n.jsxs("p",{className:"info-text",children:["Gefiltert nach ",p.firstName," ",p.lastName]}),n.jsx("div",{className:"inventory-table-wrapper",children:n.jsxs("table",{className:"inventory-table",children:[n.jsx("thead",{children:n.jsxs("tr",{children:[n.jsx("th",{children:"Artikel"}),n.jsx("th",{children:"Kategorie"}),n.jsx("th",{children:"Größe"}),n.jsx("th",{children:"Status"}),n.jsx("th",{children:"Ort"}),n.jsx("th",{children:"Zuletzt bewegt"}),n.jsx("th",{children:"Aktionen"})]})}),n.jsx("tbody",{children:j.map(e=>n.jsxs("tr",{className:e.warning?"has-warning":"",children:[n.jsxs("td",{children:[n.jsxs("div",{className:"inventory-article-id",children:["#",e.id]}),n.jsx("p",{className:"inventory-article-label",children:e.label})]}),n.jsx("td",{children:e.category}),n.jsx("td",{children:e.size??"One Size"}),n.jsxs("td",{children:[n.jsx("span",{className:`inventory-status inventory-status-${e.status}`,children:H(e)}),e.warning&&n.jsx("span",{className:"inventory-warning-pill",children:e.warning.type==="pruefung"?"Prüfung":"Ablauf"})]}),n.jsx("td",{children:e.location.type==="kind"?e.location.name:"Lager"}),n.jsx("td",{children:Z.format(new Date(e.assignedAt))}),n.jsx("td",{children:n.jsxs("div",{className:"inventory-action-group",children:[n.jsx("button",{type:"button",className:"ghost-button",onClick:()=>d(e.id),children:"Bearbeiten"}),n.jsx("button",{type:"button",className:"ghost-button danger",onClick:()=>z(e.id),disabled:A.isPending,children:"Löschen"})]})})]},e.id))})]})})]})]}),b&&n.jsx(Y,{article:b,childrenOptions:m.data??[],onClose:()=>d(null),onUpdated:q})]})}function H(s){return s.warning?"Warnung aktiv":s.status==="ausgegeben"?"Bei Kind":s.status==="frei"?"Im Lager":"Unbekannt"}export{ae as default};
